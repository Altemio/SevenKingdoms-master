# tsk_missionary_evt.1 - Missionary Arrives on your doorstep, invite or turn away
# tsk_missionary_evt.2 - Convert, ask them to leave or kill the missionary
# tsk_missionary_evt.3 - Missionary returns with troops, fight or bribe
# tsk_missionary_evt.4 - Missionary returns after bribe with even more men

namespace = tsk_missionary_evt

# A Missionary arrives

character_event = {
    id = tsk_missionary_evt.1
    desc = EVTDESCTSK_MSS_EVT_1

    trigger = {
        can_change_religion = yes
        
        NOR = {
            religion_authority = 0.8
            is_inaccessible_trigger = yes
        }
        
        OR = {
            any_vassal = {
                NOR = {
                    character = ROOT
                    religion = ROOT
                    trait = incapable
                    is_inaccessible_trigger = yes
                }
                save_event_target_as = religion_from
            }
            any_demesne_title = {
                any_neighbor_province = {
                    NOT = {
                        religion = ROOT
                        }
                        save_event_target_as = religion_from
                }
            }
            any_demesne_title = {
                tier = COUNT
                
                NOT = {
                    religion = ROOT
                }
                save_event_target_as = religion_from
            }
        }
    }
  
    mean_time_to_happen = {
        months = 12 # 9600 # Test value, high rate of event firing.
        modifier = {
            factor = 2.0
      
            religion_authority = 0.6
        }
        modifier = {
            factor = 0.75
      
            NOT = { religion_authority = 0.4 }
        }
        modifier = {
            factor = 0.75
      
            NOT = { religion_authority = 0.2 }
        }
    }
  
    # Turn them away
    option = {
        name = EVTOPTTSK_MSS_EVT1a
    
        ai_chance = {
            factor = 1
            
            modifier = {
                factor = 1.5
                trait = cynical
                trait = wroth
            }
            modifier = {
                factor = 5
                trait = zealous
                NOT = { trait = cruel}
            }
            modifier = {
                factor = 1.5
                trait = brave
            }
        }
        random_list = {
            30 = { }
            70 = { character_event = { id = tsk_missionary_evt.3 } }
        }
    }
    
    # Invite them in
    option = {
        name = EVTOPTTSK_MSS_EVT1b
    
        ai_chance = {
            factor = 1
            
            modifier = {
                factor = 3
                trait = cynical
            }
            modifier = {
                factor = 5
                trait = zealous
                trait = cruel
            }
            modifier = {
                factor = 2
                trait = arbitrary
            }
            modifier = {
                factor = 2
                trait = patient
            }
            modifier = {
                factor = 0.5
                trait = wroth
            }
        }
        character_event = { id = tsk_missionary_evt.2 }
        
    }
}

# Invited in

character_event = {
    id = tsk_missionary_evt.2
    desc = EVTDESCTSK_MSS_EVT_2

    is_triggered_only = yes

    # Accept their offer (convert)
    option = {
        name = EVTOPTTSK_MSS_EVT2a
        
        prestige = -50
        piety = -200
        
        event_target:religion_from = {
            reverse_religion = ROOT
        }
        
        ai_chance = {
            factor = 1
            
            modifier = {
                factor = 2
                trait = cynical
                trait = kind
            }
            modifier = {
                factor = 2
                trait = cynical
                trait = patient
            }
            modifier = {
                factor = 1.5
                trait = cynical
            }
        }
    }
    # Decline their offer.
    option = {
        name = EVTOPTTSK_MSS_EVT2b
        
        ai_chance = {
            factor = 1
            
            modifier = {
                factor = 2
                trait = zealous
                trait = kind
            }
            modifier = {
                factor = 2
                trait = zealous
                trait = patient
            }
        }

        random_list = {
            50 = { }
            50 = { character_event = { id = tsk_missionary_evt.3 } }
        }
    }
    # Have them killed (end chain)
    option = {
        name = EVTOPTTSK_MSS_EVT2c
        
        if = {
            limit = {
                trait = cruel
            }
            add_trait = heartless
        }
        
        if = {
            limit = {
                trait = kind
            }
            remove_trait = kind
        }
        
        if = {
            limit = {
                NOR = {
                    trait = kind
                    trait = heartless
                    trait = cruel
                }
            }
            add_trait = cruel
        }
        
        ai_chance = {
            factor = 1
            
            modifier = {
                factor = 4
                trait = zealous
                trait = cruel
            }
            modifier = {
                factor = 2
                trait = zealous
                trait = wroth
            }
            modifier = {
                factor = 4
                trait = cruel
            }
        }
    }
}

# Returns with soldiers

character_event = {
    id = tsk_missionary_evt.3
    desc = EVTDESCTSK_MSS_EVT_3

    is_triggered_only = yes

    # Accept their demands (forcefully convert, loss of prestige)
    option = {
        name = EVTOPTTSK_MSS_EVT3a
        
        prestige = -250
        piety = -50
        
        event_target:religion_from = {
            reverse_religion = ROOT
        }
    }
    # Fight them (spawns normal rebel stack)
    option = {
        name = EVTOPTTSK_MSS_EVT3b
        
        piety = 50
        prestige = 50
        
        capital_scope = {
            create_character = {
                random_traits = yes
                dynasty = none
                religion = ROOT
                culture = ROOT
                female = no
                age = 25
                attributes = {
                    martial = 5
                }
                trait = peasant_leader
                trait = tough_soldier
            }

            new_character = {
                create_title = {
                    tier = DUKE
                    landless = yes
                    temporary = yes
                    rebel = yes
                    culture = ROOT
                    name = "PEASANT_REVOLT"
                    holder = THIS
                }

                wealth = 100

                spawn_peasant_army_effect = yes

                if = {
                    limit = {
                        has_game_rule = {
                            name = provincial_revolt_strength
                            value = powerful
                        }
                    }
                    spawn_peasant_army_effect = yes
                    wealth = 150
                }

                if = {
                    limit = {
                        has_game_rule = {
                            name = provincial_revolt_strength
                            value = very_powerful
                        }
                    }
                    spawn_peasant_army_effect = yes
                    spawn_peasant_army_effect = yes
                    spawn_peasant_army_effect = yes
                    wealth = 250
                }

                if = {
                    limit = {
                        has_game_rule = {
                            name = provincial_revolt_strength
                            value = extremely_powerful
                        }
                    }
                    spawn_peasant_army_effect = yes
                    spawn_peasant_army_effect = yes
                    spawn_peasant_army_effect = yes
                    spawn_peasant_army_effect = yes
                    spawn_peasant_army_effect = yes
                    wealth = 350
                }

                # DoW on the province top liege
                ROOT = {
                    owner = {
                        top_liege = {
                            reverse_war = {
                                target = PREVPREVPREV
                                casus_belli = peasant_revolt
                                thirdparty_title = ROOT
                            }
                            reverse_opinion = {
                                who = PREVPREVPREV
                                modifier = opinion_evil_tyrant
                            }
                        }
                    }
                }
            }
        }
    }
    # Pay them off with gold (chance of failure, take gold either way).
    option = {
        name = EVTOPTTSK_MSS_EVT3c
        
        scaled_wealth = -0.9
        
        piety = 25
        prestige = 25

        random_list = {
            95 = { }
            5 = { character_event = { id = tsk_missionary_evt.4 } }
        }
        
        ai_chance = {
            factor = 1
            
            modifier = {
                factor = 0.5
                trait = greedy
            }
            modifier = {
                factor = 4
                OR = {
                    trait = midas_touched
                    trait = elusive_shadow
                }
            }
            modifier = {
                factor = 2
                OR = {
                    trait = intricate_webweaver
                    trait = flamboyant_schemer
                    trait = amateurish_plotter
                    trait = fortune_builder
                    trait = thrifty_clerk
                    trait = indulgent_wastrel
                }
            }
        }
    }
}

# Gold taken, still rise up (with more men)

character_event = {
    id = tsk_missionary_evt.4
    desc = EVTDESCTSK_MSS_EVT_4

    is_triggered_only = yes

    # Deal with it
    option = {
        name = EVTOPTTSK_MSS_EVT4a
        capital_scope = {
            create_character = {
                random_traits = yes
                dynasty = none
                religion = ROOT
                culture = ROOT
                female = no
                age = 25
                attributes = {
                    martial = 5
                }
                trait = peasant_leader
                trait = tough_soldier
            }

            new_character = {
                create_title = {
                    tier = DUKE
                    landless = yes
                    temporary = yes
                    rebel = yes
                    culture = ROOT
                    name = "PEASANT_REVOLT"
                    holder = THIS
                }

                wealth = 500

                spawn_peasant_army_effect = yes
                spawn_peasant_army_effect = yes

                if = {
                    limit = {
                        has_game_rule = {
                            name = provincial_revolt_strength
                            value = powerful
                        }
                    }
                    spawn_peasant_army_effect = yes
                    spawn_peasant_army_effect = yes
                    wealth = 550
                }

                if = {
                    limit = {
                        has_game_rule = {
                            name = provincial_revolt_strength
                            value = very_powerful
                        }
                    }
                    spawn_peasant_army_effect = yes
                    spawn_peasant_army_effect = yes
                    spawn_peasant_army_effect = yes
                    spawn_peasant_army_effect = yes
                    wealth = 650
                }

                if = {
                    limit = {
                        has_game_rule = {
                            name = provincial_revolt_strength
                            value = extremely_powerful
                        }
                    }
                    spawn_peasant_army_effect = yes
                    spawn_peasant_army_effect = yes
                    spawn_peasant_army_effect = yes
                    spawn_peasant_army_effect = yes
                    spawn_peasant_army_effect = yes
                    spawn_peasant_army_effect = yes
                    wealth = 750
                }

                # DoW on the province top liege
                ROOT = {
                    owner = {
                        top_liege = {
                            reverse_war = {
                                target = PREVPREVPREV
                                casus_belli = peasant_revolt
                                thirdparty_title = ROOT
                            }
                            reverse_opinion = {
                                who = PREVPREVPREV
                                modifier = opinion_evil_tyrant
                            }
                        }
                    }
                }
            }
        }
    }
}
